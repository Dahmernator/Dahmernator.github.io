<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Canvas with Gravity</title>
<style>
    canvas {
        border: 1px solid black;
    }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD5aNloa6l4xAyIKSP78bU_Hjl_iRRoJKA",
        authDomain: "volleyball-game-5344a.firebaseapp.com",
        databaseURL: "https://volleyball-game-5344a-default-rtdb.firebaseio.com",
        projectId: "volleyball-game-5344a",
        storageBucket: "volleyball-game-5344a.appspot.com",
        messagingSenderId: "12860376010",
        appId: "1:12860376010:web:f6c45720c5bc83ccfbc533",
        measurementId: "G-D00RCW570B"
    };

    firebase.initializeApp(firebaseConfig);
    var server = firebase.database().ref('server-0');

    var canvas = document.getElementById("gameCanvas");
    var ctx = canvas.getContext("2d");

    var player = {
        x: 50,
        y: canvas.height - 100,
        width: 30,
        height: 100,
        velocityX: 0,
        velocityY: 0,
        accelX: 0,
        gravity: 0.5,
        moveable: true,
        color: "#0000FF",
        speed: 5,
        jump: -10,
        bounciness: 0,//from 0-1
        facing: true,//true means right, fasle means left
        follows: null,
    };
    var playerArm = {
        x: player.x + 16,
        y: player.y + 30,
        width: 14,
        height: 50,
        velocityX: 0,
        velocityY: 0,
        accelX: 0,
        gravity: 0,
        moveable: false,
        color: "#000000",
        speed: 0,
        jump: 0,
        bounciness: 0,//from 0-1
        facing: 1,//1 means right, -1 means left
        follows: player,
        followsXOff: 16,
        followsYOff: 30,
    }
    var playerHead = {
        x: player.x,
        y: player.y,
        width: 30,
        height: 30,
        velocityX: 0,
        velocityY: 0,
        accelX: 0,
        gravity: 0,
        moveable: false,
        color: "#d6c498",
        speed: 0,
        jump: 0,
        bounciness: 0,//from 0-1
        facing: 1,//1 means right, -1 means left
        follows: player,
        followsXOff: 0,
        followsYOff: 0,
    }

    var movingObjArr = [player, playerArm, playerHead];

    // Function to handle key down events
    function handleKeyDown(event) {
        if (event.key === "ArrowLeft") {
            player.velocityX = -player.speed;
        } else if (event.key === "ArrowRight") {
            player.velocityX = player.speed;
        } else if (event.key === " "){
            console.log("space");
            if(playerIsGrounded()){
                player.velocityY = player.jump;
            }
        }
        updateFirebase();
    }

    // Function to handle key up events
    function handleKeyUp(event) {
        if (event.key === "ArrowLeft" || event.key === "ArrowRight") {
            player.velocityX = 0;
        }
        updateFirebase();
    }

    // Function to update game state
    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (var i = 0; i < movingObjArr.length; i++) {
            updatePlayer(movingObjArr[i]);
            drawPlayer(movingObjArr[i]);
        }
        requestAnimationFrame(update);
    }

    // Function to update player's position and handle collisions
    function updatePlayer(player) {
        if (player.moveable) {
            player.velocityX += player.accelX;
            player.velocityY += player.gravity;
            player.x += player.velocityX;
            player.y += player.velocityY;
            if (player.x + player.width >= canvas.width) {
                player.velocityX *= -1*player.bounciness;
                player.x -= (player.x + player.width - canvas.width) * (1 + player.bounciness);
            } else if (player.x <= 0) {
                player.velocityX *= -1*player.bounciness;
                player.x -= player.x * (1+player.bounciness);
            }
            if (player.y + player.height >= canvas.height) {
                player.velocityY *= -1*player.bounciness;
                player.y -= (player.y + player.height - canvas.height) * (1 + player.bounciness);//(1+bounciness) needs to be 2* with full bounce and 1* to go to the end go the canvas
            }
            if(player.velocityX != 0){
                player.facing = Math.round(player.velocityX/Math.abs(player.velocityX));
            }
        }
        if(player.follows != null){
            if(player.follows.facing == 1){
                player.x = player.follows.x + player.followsXOff;
            }else{
                player.x = player.follows.x;
            }
            player.y = player.follows.y + player.followsYOff;
        }
    }

    // Function to draw player on canvas
    function drawPlayer(player) {
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.width, player.height);
    }

    function playerIsGrounded(){
        if(canvas.height == Math.round(player.height + player.y)){
            return true
        }
        return false
    }

    // Function to update Firebase with player's position
    function updateFirebase() {
        var serverMessage = server.child("player1");
        serverMessage.set({
            x: player.x,
            y: player.y,
            vX: player.velocityX,
            vY: player.velocityY,
        });
    }

    // Event listeners for keyboard input
    document.addEventListener("keydown", handleKeyDown);
    document.addEventListener("keyup", handleKeyUp);

    server.on('value', function(snapshot) {
    var serverData = snapshot.val();
    if (serverData && serverData.player1) {
        // Use the server data if available, otherwise fallback to player.x
        if(Math.round(serverData.player1.vX) == 0){
            player.x = Math.round((serverData.player1.x !== undefined ? serverData.player1.x : player.x) * 100) / 100;
        }
        player.velocityX = Math.round((serverData.player1.vX !== undefined ? serverData.player1.vX : player.velocityX) * 100) / 100;
        if(Math.round(serverData.player1.vY) == 0){
            player.y = Math.round((serverData.player1.y !== undefined ? serverData.player1.y : player.y) * 100) / 100; 
        }
        player.velocityY = Math.round((serverData.player1.vY !== undefined ? serverData.player1.vY : player.velocityY) * 100) / 100;

    } else {
        // Handle missing or invalid data
        console.error('Invalid data received from server');
    }
}, function(error) {
    console.error('Error fetching data:', error);
});
    // Start the game loop
    requestAnimationFrame(update);

</script>
</body>
</html>
